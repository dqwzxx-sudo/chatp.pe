<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Grupo Fixion Oficial - Chat en Tiempo Real</title>
<style>
:root { --border:#e5e7eb; --bg:#fafafa; --muted:#6b7280; --primary:#3b82f6; }
body { font-family: system-ui, Arial, sans-serif; margin:0; padding:0; background:#f0f4f8; }
header {
  position: fixed; top:0; left:0; width:100%; height:60px;
  background:#fff; border-bottom:1px solid var(--border); display:flex;
  align-items:center; justify-content:space-between; padding:0 16px; z-index:1000;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}
header .header-left { display:flex; align-items:center; gap:8px; }
header .header-left img { width:40px; height:40px; border-radius:8px; }
header .header-left h1 { font-size:1.2rem; margin:0; color:var(--primary); }
header .header-right {margin-right: 30px; display:flex; align-items:center; gap:12px; }
header .header-right .avatar { width:36px; height:36px; border-radius:50%; border:1px solid var(--border); }
header .header-right .name { font-weight:600; color:#333; }
header .header-right .btn { padding:6px 10px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; transition:all 0.2s; }
header .header-right .btn:hover { background:var(--primary); color:#fff; border-color:var(--primary); }

main { padding-top:70px; max-width:720px; margin:0 auto; }

#chat { border:1px solid var(--border); background:#fff; height:400px; overflow-y:auto; padding:12px; border-radius:12px; scroll-behavior:smooth; margin:16px 0; }
.msg { display:flex; gap:10px; padding:10px 8px; border-bottom:1px solid var(--border); animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
.msg:last-child { border-bottom:none; }
.msg .meta { display:flex; align-items:center; gap:8px; }
.msg .name { font-weight:600; color:var(--primary); }
.msg .time { color:var(--muted); font-size:12px; }
.msg .bubble { margin-left:48px; display:flex; flex-direction:column; gap:4px; }
.msg img.content, .msg video.content, .msg iframe { max-width:280px; border-radius:10px; border:1px solid var(--border); }

/* Videos TikTok más grandes */
.msg iframe.tiktok-video { 
  width: 110%;       /* ocupa todo el ancho del contenedor */
  max-width: none;  /* opcional: limita si el chat es muy ancho */
  height: 600px;     /* más alto para TikTok */
  border-radius:12px; 
  border:1px solid var(--border); 
}



.controls { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
.controls input[type="text"], .controls input[type="url"], .controls input[type="file"] { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; }
.btn { padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; transition:all 0.2s ease; }
.btn:hover { background:var(--primary); color:#fff; border-color:var(--primary); }
.btn:disabled { opacity:.6; cursor:not-allowed; }
.hint { color:var(--muted); font-size:12px; margin-top:4px; }
.hidden { display:none; }
#linkPreview, #filePreview { max-width:200px; display:none; border:1px solid #ccc; border-radius:8px; margin-top:4px; }

@media(max-width:500px){
  .controls { flex-direction:column; }
  .msg img.content, .msg video.content, .msg iframe { max-width:100%; }
}
.avatar{
  width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--border);
}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <img src="https://i.imgur.com/2yAf7OH.png" alt="Grupo Fixion Logo">
    <h1>Grupo Fixion Oficial</h1>
  </div>
  <div class="header-right">
    <img id="user-photo" class="avatar" src="" alt="avatar" style="display:none;">
    <span id="user-name" class="name">No has iniciado sesión</span>
    <button id="loginBtn" class="btn">Iniciar sesión con Google</button>
    <button id="logoutBtn" class="btn hidden">Cerrar sesión</button>
  </div>
</header>

<main>
  <div id="chat"></div>

  <div class="controls">
    <input id="nicknameInput" type="text" placeholder="Ingresa tu apodo">
  </div>

  <div class="controls">
    <input id="msgInput" type="text" placeholder="Escribe un mensaje…">
  </div>

  <div class="controls">
    <input id="fileInput" type="file" accept="image/*,video/*">
    <input id="linkInput" type="url" placeholder="O pega un link de imagen/video/TikTok…">
    <button id="sendBtn" class="btn" disabled>Enviar</button>
  </div>

  <div class="controls">
    <img id="linkPreview" alt="Previsualización">
    <video id="filePreview" controls></video>
  </div>

  <div class="hint">Puedes enviar texto y/o imagen/video (archivo o link) con un solo botón.</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref as dbRef, push, onChildAdded } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAu-L2QmUixoxM3SzYfV55ZL85CSHq_P6Y",
  authDomain: "chat-realtime-2b260.firebaseapp.com",
  databaseURL: "https://chat-realtime-2b260-default-rtdb.firebaseio.com",
  projectId: "chat-realtime-2b260",
  storageBucket: "chat-realtime-2b260.appspot.com",
  messagingSenderId: "773600463978",
  appId: "1:773600463978:web:9ac8dc508a4642c768e13",
  measurementId: "G-G7CTT0BNQ4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getDatabase(app);

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userPhoto = document.getElementById("user-photo");
const userName = document.getElementById("user-name");
const chatBox = document.getElementById("chat");
const msgInput = document.getElementById("msgInput");
const fileInput = document.getElementById("fileInput");
const linkInput = document.getElementById("linkInput");
const linkPreview = document.getElementById("linkPreview");
const filePreview = document.getElementById("filePreview");
const sendBtn = document.getElementById("sendBtn");
const nicknameInput = document.getElementById("nicknameInput");

let currentUser = null;
let nickname = "";

function fmtTime(ts){ return new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}); }

// Detecta YouTube y TikTok
function parseVideoUrl(url){
  // YouTube
  const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([a-zA-Z0-9_-]+)/);
  if(ytMatch) return { type:"youtube", embed:`https://www.youtube.com/embed/${ytMatch[1]}` };

  // TikTok
  const ttMatch = url.match(/(?:tiktok\.com\/.+\/video\/)(\d+)/);
  if(ttMatch) return { type:"tiktok", embed:`https://www.tiktok.com/embed/${ttMatch[1]}` };

  return null;
}

function renderMessage({ name, photo, text, url, ts }){
  const row = document.createElement("div");
  row.className = "msg";

  const avatar = document.createElement("img");
  avatar.className = "avatar";
  avatar.src = photo||"";
  avatar.alt = name||"user";

  const head = document.createElement("div");
  head.className = "meta";
  const nameEl = document.createElement("span");
  nameEl.className = "name";
  nameEl.textContent = name||"Usuario";
  const timeEl = document.createElement("span");
  timeEl.className = "time";
  timeEl.textContent = fmtTime(ts||Date.now());
  head.appendChild(nameEl);
  head.appendChild(timeEl);

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  if(url){
    const videoData = parseVideoUrl(url);
    if(videoData){
      const iframe = document.createElement("iframe");
      iframe.src = videoData.embed;
      iframe.width = "100%"; 
      iframe.frameBorder = "0";
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      if(videoData.type === "tiktok") iframe.classList.add("tiktok-video"); // aplica CSS para ancho/alto
      bubble.appendChild(iframe);
    } else if(url.match(/\.(mp4|webm|ogg)$/i)){
      const vid = document.createElement("video");
      vid.src = url;
      vid.controls = true;
      vid.className = "content";
      bubble.appendChild(vid);
    } else {
      const img = document.createElement("img");
      img.className = "content";
      img.src = url;
      img.alt = "Contenido";
      bubble.appendChild(img);
    }
  }

  if(text){
    const p = document.createElement("div");
    p.textContent = text;
    bubble.appendChild(p);
  }

  row.appendChild(avatar);
  const block = document.createElement("div");
  block.appendChild(head);
  block.appendChild(bubble);
  row.appendChild(block);
  chatBox.appendChild(row);
  chatBox.scrollTop = chatBox.scrollHeight;
}

const mensajesRef = dbRef(db,"mensajes");
onChildAdded(mensajesRef, snap=>{
  const v = snap.val()||{};
  renderMessage({ name:v.name, photo:v.photo, text:v.text, url:v.url, ts:v.ts||Date.now() });
});

linkInput.addEventListener("input", ()=>{
  const url = linkInput.value.trim();
  if(url.match(/\.(jpeg|jpg|gif|png|webp|mp4|webm|ogg)$/i) || parseVideoUrl(url)){
    linkPreview.src = url;
    linkPreview.style.display = "block";
    filePreview.src = url;
    filePreview.style.display = "block";
  } else {
    linkPreview.src = "";
    linkPreview.style.display = "none";
    filePreview.src = "";
    filePreview.style.display = "none";
  }
});

nicknameInput.addEventListener("input", ()=>{nickname = nicknameInput.value.trim();});

async function sendMessage(){
  if(!currentUser) return;
  const text = msgInput.value.trim();
  const file = fileInput.files?.[0];
  const link = linkInput.value.trim();
  if(!text && !file && !link) return;

  msgInput.value = "";
  fileInput.value = "";
  linkInput.value = "";
  linkPreview.src = "";
  linkPreview.style.display = "none";
  filePreview.src = "";
  filePreview.style.display = "none";

  let urlToSend = link || "";
  if(file){
    alert("Para subir archivos reales, configura un servidor o Postimages API. Actualmente solo se envían links.");
  }

  await push(mensajesRef,{
    uid: currentUser.uid,
    name: nickname || currentUser.displayName,
    photo: currentUser.photoURL,
    text: text||"",
    url: urlToSend||"",
    ts: Date.now()
  });
}

sendBtn.addEventListener("click", sendMessage);
msgInput.addEventListener("keydown", (e)=>{if(e.key==="Enter") sendMessage();});

loginBtn.addEventListener("click", ()=>signInWithPopup(auth,provider));
logoutBtn.addEventListener("click", ()=>signOut(auth));

onAuthStateChanged(auth,user=>{
  currentUser = user||null;
  if(user){
    userName.textContent = user.displayName||user.email||"Usuario";
    if(user.photoURL){ userPhoto.src=user.photoURL; userPhoto.style.display="block"; } else userPhoto.style.display="none";
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    sendBtn.disabled = false;
  } else {
    userName.textContent = "No has iniciado sesión";
    userPhoto.style.display="none";
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    sendBtn.disabled = true;
  }
});
</script>
</body>
</html>
